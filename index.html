<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页视频录制工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .extension-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .extension-banner::before {
            content: "🚀";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 4rem;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        .extension-banner h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .extension-banner p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .extension-banner .btn {
            background: white;
            color: #ee5a24;
            font-weight: 700;
            padding: 15px 30px;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .extension-banner .btn:hover {
            background: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .extension-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .extension-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .extension-feature::before {
            content: "✓";
            font-weight: bold;
            color: #4CAF50;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .feature-card h3 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .feature-card h3::before {
            content: "🎥";
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .web-recorder {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .web-recorder h2 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .recorder-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .recorder-status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .status-ready {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-recording {
            background: #ffebee;
            color: #c62828;
            animation: pulse 1.5s infinite;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .status-recording::before {
            content: "🔴 ";
            margin-right: 8px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .video-container {
            text-align: center;
            margin-top: 20px;
        }

        .video-container video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .video-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .video-list h3 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .video-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .video-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .video-item.active {
            background: #e8f5e8;
            border-color: #2e7d32;
        }

        .video-thumbnail {
            width: 80px;
            height: 60px;
            background: #ddd;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.8rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .video-meta {
            font-size: 0.9rem;
            color: #666;
        }

        .video-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
        }

        .btn-icon {
            padding: 8px;
            font-size: 0.9rem;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-loading {
            background: #ccc !important;
            cursor: not-allowed !important;
            position: relative;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-videos {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-videos p {
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            opacity: 0.8;
        }

        .footer a {
            color: white;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .extension-banner h2 {
                font-size: 1.5rem;
            }
            
            .extension-banner p {
                font-size: 1rem;
            }
            
            .extension-features {
                flex-direction: column;
                gap: 10px;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .recorder-controls {
                flex-direction: column;
                align-items: center;
            }

            .video-item {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .video-thumbnail {
                margin-right: 0;
                margin-bottom: 15px;
                width: 100px;
                height: 75px;
            }
            
            .video-actions {
                margin-top: 15px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>网页视频录制工具</h1>
            <p>简单易用的网页视频录制解决方案</p>
        </div>

        <!-- 网页录制功能 -->
        <div class="web-recorder">
            <h2>在线录制功能</h2>
            <p style="text-align: center; margin-bottom: 20px; color: #666;">
                直接在浏览器中录制屏幕、摄像头或音频，无需安装任何软件
            </p>
            
            <div class="recorder-status status-ready" id="status">
                准备就绪 - 点击开始录制
            </div>
            
            <div class="recorder-controls">
                <button class="btn" id="startBtn">开始录制</button>
                <button class="btn btn-secondary" id="pauseBtn" style="display:none;">暂停录制</button>
                <button class="btn btn-secondary" id="resumeBtn" style="display:none;">恢复录制</button>
                <button class="btn btn-secondary" id="stopBtn" disabled>停止录制</button>
            </div>
            
            <div class="video-container" id="videoContainer" style="display: none;">
                <video id="preview"></video>
            </div>
        </div>

        <!-- 录制历史 -->
        <div class="video-list">
            <h3>录制历史</h3>
            <div id="videoList">
                <div class="no-videos">
                    <p>暂无录制视频</p>
                    <p>开始录制后，视频将显示在这里</p>
                </div>
            </div>
        </div>

        <!-- 插件宣传横幅 -->
        <div class="extension-banner">
            <h2>🚀 推荐使用 Chrome 插件版本</h2>
            <p>获得更好的录制体验，支持更多功能，无需重复打开网页</p>
            <a href="https://chromewebstore.google.com/detail/%E7%BD%91%E9%A1%B5%E8%A7%86%E9%A2%91%E5%BD%95%E5%88%B6%E5%99%A8/eignncjkllfggpdaacflgeioaoajgjoj?hl=en-GB&utm_source=ext_sidebar" 
               target="_blank" class="btn">
                立即安装插件
            </a>
            <div class="extension-features">
                <div class="extension-feature">一键录制</div>
                <div class="extension-feature">录制历史管理</div>
                <div class="extension-feature">视频格式转换</div>
                <div class="extension-feature">离线使用</div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 网页视频录制工具 | 
                <a href="https://github.com/lijian316/record" target="_blank">GitHub</a> | 
                <a href="privacy_policy.html" target="_blank">隐私政策</a>
            </p>
        </div>
    </div>

</body>
<script>
let mediaRecorder;
let recordedChunks = [];
let isRecording = false;
let isPaused = false;
let currentStream = null;
let videoList = [];
let recordingTimer = null;
let recordingStartTime = null;
let pausedTime = 0;

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const status = document.getElementById('status');
const videoContainer = document.getElementById('videoContainer');
const preview = document.getElementById('preview');
const videoListContainer = document.getElementById('videoList');

startBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
pauseBtn.addEventListener('click', pauseRecording);
resumeBtn.addEventListener('click', resumeRecording);

// 页面加载时加载视频列表
loadVideoList();

// 自动录制逻辑
function autoStartRecording() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auto') === '1' && !isRecording) {
        console.log('检测到自动录制参数，开始录制');
        const tryClick = () => {
            if (startBtn && !startBtn.disabled && !isRecording) {
                startBtn.click();
            } else if (!isRecording) {
                setTimeout(tryClick, 200);
            }
        };
        tryClick();
    }
}

// 页面加载时执行自动录制
window.addEventListener('DOMContentLoaded', () => {
    // 网页端直接执行自动录制逻辑
    autoStartRecording();
});

// 监听页面可见性变化，当页面重新激活时检查是否需要重新录制
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && !isRecording) {
        // 页面重新可见且当前没有录制时，检查是否需要自动录制
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auto') === '1') {
            console.log('页面重新激活，延迟执行自动录制');
            setTimeout(autoStartRecording, 1000); // 延迟1秒执行
        }
    }
});

function notifyBackground(action) {
    // 网页端不需要通知background
    console.log('网页端操作:', action);
}

// 格式化录制时长
function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// 更新录制时长显示
function updateRecordingTime() {
    if (isRecording && recordingStartTime) {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        status.textContent = `正在录制中... ${formatDuration(elapsed)}`;
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                cursor: "always"
            },
            audio: true
        });

        currentStream = stream;

        let mimeType = 'video/webm;codecs=vp9';

        if (!MediaRecorder.isTypeSupported(mimeType)) {
        console.warn(mimeType + ' is not supported on this browser, using alternative');
        mimeType = 'video/webm;codecs=vp8';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
            console.warn(mimeType + ' is not supported on this browser, using alternative');
            mimeType = 'video/mp4;codecs=avc1';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
            console.error('No suitable MIME type found for this browser');
            }
        }
        }
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: mimeType
        });

        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, {
                type: 'video/webm'
            });
            
            if (recordedChunks.length === 0) {
                console.error('录制数据为空，无法保存');
                return;
            }
            
            if (blob.size === 0) {
                console.error('录制的 Blob 大小为0，无法保存');
                return;
            }
            
            // 停止实时预览，显示录制结果
            preview.srcObject = null;
            preview.src = URL.createObjectURL(blob);
            preview.controls = true;
            preview.muted = false;
            videoContainer.style.display = 'block';
            
            // 保存blob用于下载
            preview.dataset.blob = blob;

            // 添加到视频列表
            addVideoToList(blob);

            // 通知popup录制已停止
            console.log('录制已停止');
            
            // 通知background录制已停止（兜底）
            notifyBackground('stopRecording');
            
            // 通知插件保存录制历史
            const generateVideoFilename = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const second = String(now.getSeconds()).padStart(2, '0');
                
                return `video_${year}${month}${day}_${hour}${minute}${second}`;
            };
            
            const recordingData = {
                id: Date.now() + Math.random(),
                timestamp: Date.now(),
                size: blob.size,
                filename: generateVideoFilename(),
                blob: blob
            };
            
            // 将 Blob 转换为 base64 字符串后再发送
            const reader = new FileReader();
            reader.onload = () => {
                const messageData = {
                    action: 'saveRecordingToHistory',
                    recording: {
                        ...recordingData,
                        blobData: reader.result, // base64 字符串
                        blob: null // 移除 blob 对象
                    }
                };
                
                // 添加重试机制
                let retryCount = 0;
                const maxRetries = 3;
                
                const saveRecording = () => {
                    // 网页端直接保存到本地存储
                    console.log('保存录制到本地存储');
                    // 这里可以添加本地存储逻辑
                };
                
                saveRecording();
            };
            
            reader.onerror = (error) => {
                console.error('Blob 转换为 base64 失败:', error);
            };
            
            reader.readAsDataURL(blob);
        };

        // 监听流结束事件（用户点击停止分享）
        stream.getVideoTracks()[0].onended = () => {
            console.log('用户停止了屏幕分享');
            if (isRecording) {
                stopRecording();
            }
        };

        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // 通知popup真正开始录制
        console.log('录制已开始');
        
        // 开始实时预览
        preview.srcObject = stream;
        preview.muted = true;
        preview.autoplay = true;
        preview.controls = false;
        videoContainer.style.display = 'block';
        
        // 确保视频开始播放
        preview.play().catch(e => {
            console.log('自动播放失败，用户需要手动点击:', e);
        });
        
        // 启动录制时长计时器
        recordingTimer = setInterval(updateRecordingTime, 1000);
        
        startBtn.disabled = true;
        startBtn.style.display = 'none';
        pauseBtn.style.display = '';
        resumeBtn.style.display = 'none';
        stopBtn.disabled = false;
        
        status.textContent = '正在录制中... 00:00:00';
        status.className = 'recorder-status status-recording';

        // 通知background录制已开始
        notifyBackground('startRecording');
        
    } catch (error) {
        // 区分不同类型的错误
        if (error.name === 'NotAllowedError' || error.name === 'NotReadableError') {
            // 用户取消了屏幕选择或权限被拒绝
            console.log('用户取消了屏幕选择或权限被拒绝');
            
            // 通知popup录制已停止（用户取消）
            console.log('用户取消录制');
            
            // 不显示错误提示，因为这是用户主动取消
        } else {
            // 其他错误显示提示
            alert('录制失败: ' + error.message);
        }
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        
        // 停止所有轨道
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        
        // 停止录制时长计时器
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        isRecording = false;
        isPaused = false; // 重置暂停状态
        recordingStartTime = null;
        pausedTime = 0;
        startBtn.disabled = false;
        startBtn.style.display = '';
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'none';
        stopBtn.disabled = true;
        
        status.textContent = '录制完成';
        status.className = 'recorder-status status-ready';
        
        // 通知popup录制已停止
        console.log('录制已停止');
        
        // 通知background录制已停止（兜底）
        notifyBackground('stopRecording');
    }
}

function pauseRecording() {
    if (mediaRecorder && isRecording && !isPaused) {
        try {
            mediaRecorder.pause();
            isPaused = true;
            pausedTime = Date.now();
            
            // 停止录制时长计时器
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            startBtn.disabled = true;
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = '';
            stopBtn.disabled = false;
            
            status.textContent = '录制已暂停';
            status.className = 'recorder-status status-ready';
            
            // 通知background录制已暂停
            console.log('录制已暂停');
            
            console.log('录制已暂停');
        } catch (error) {
            console.error('暂停录制失败:', error);
        }
    }
}

function resumeRecording() {
    if (mediaRecorder && isRecording && isPaused) {
        try {
            mediaRecorder.resume();
            isPaused = false;
            
            // 调整录制开始时间，补偿暂停的时间
            const pauseDuration = Date.now() - pausedTime;
            recordingStartTime += pauseDuration;
            pausedTime = 0;
            
            // 重新启动录制时长计时器
            recordingTimer = setInterval(updateRecordingTime, 1000);
            
            startBtn.disabled = true;
            startBtn.style.display = '';
            pauseBtn.style.display = '';
            resumeBtn.style.display = 'none';
            stopBtn.disabled = false;
            
            status.textContent = '正在录制中...';
            status.className = 'recorder-status status-recording';
            
            // 通知background录制已恢复
            console.log('录制已恢复');
        } catch (error) {
            console.error('恢复录制失败:', error);
        }
    }
}

function addVideoToList(blob) {
    const generateVideoName = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        
        return `video_${year}${month}${day}_${hour}${minute}${second}`;
    };
    
    const videoItem = {
        id: Date.now() + Math.random(),
        name: generateVideoName(),
        blob: blob,
        size: blob.size,
        date: new Date().toISOString(),
        url: URL.createObjectURL(blob),
        converting: false
    };

    videoList.unshift(videoItem);
    saveVideoList();
    updateVideoListDisplay();
}

function updateVideoListDisplay() {
    if (videoList.length === 0) {
        videoListContainer.innerHTML = `
            <div class="no-videos">
                <p>暂无录制视频</p>
                <p>开始录制后，视频将显示在这里</p>
            </div>
        `;
        return;
    }

    videoListContainer.innerHTML = '';
    videoList.forEach(video => {
        const videoItemDiv = document.createElement('div');
        videoItemDiv.className = 'video-item';
        videoItemDiv.dataset.id = video.id;

        // 缩略图
        const thumbDiv = document.createElement('div');
        thumbDiv.className = 'video-thumbnail';
        const thumbVideo = document.createElement('video');
        thumbVideo.src = video.url;
        thumbVideo.muted = true;
        thumbVideo.addEventListener('loadedmetadata', function() {
            if (this.duration && isFinite(this.duration) && this.duration > 0) {
                this.currentTime = this.duration / 2;
            }
        });
        thumbDiv.appendChild(thumbVideo);
        videoItemDiv.appendChild(thumbDiv);

        // 信息
        const infoDiv = document.createElement('div');
        infoDiv.className = 'video-info';
        const titleDiv = document.createElement('div');
        titleDiv.className = 'video-title';
        titleDiv.textContent = video.name;
        const metaDiv = document.createElement('div');
        metaDiv.className = 'video-meta';
        metaDiv.textContent = `${formatFileSize(video.size)} • ${new Date(video.date).toLocaleString()}`;
        infoDiv.appendChild(titleDiv);
        infoDiv.appendChild(metaDiv);
        videoItemDiv.appendChild(infoDiv);

        // 操作按钮
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'video-actions';

        // WebM下载按钮
        const webmBtn = document.createElement('button');
        webmBtn.className = 'btn btn-small';
        webmBtn.title = '下载WebM格式';
        webmBtn.textContent = 'WebM';
        webmBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            downloadVideoFromList(video.id, 'webm');
        });
        actionsDiv.appendChild(webmBtn);

        // MP4下载按钮
        const mp4Btn = document.createElement('button');
        mp4Btn.className = 'btn btn-small btn-success';
        if (video.converting) mp4Btn.classList.add('btn-loading');
        mp4Btn.title = '转换为MP4格式';
        mp4Btn.textContent = video.converting ? '转换中...' : 'MP4';
        mp4Btn.disabled = !!video.converting;
        mp4Btn.addEventListener('click', function(event) {
            event.stopPropagation();
            downloadVideoFromList(video.id, 'mp4');
        });
        actionsDiv.appendChild(mp4Btn);

        // 删除按钮
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-icon btn-secondary';
        delBtn.title = '删除';
        delBtn.textContent = '🗑️';
        delBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            deleteVideo(video.id);
        });
        actionsDiv.appendChild(delBtn);

        videoItemDiv.appendChild(actionsDiv);

        // 点击播放
        videoItemDiv.addEventListener('click', function() {
            playVideo(video.id);
        });

        videoListContainer.appendChild(videoItemDiv);
    });

    // 高亮当前播放项
    document.querySelectorAll('.video-item').forEach(item => {
        item.classList.remove('active');
    });
    if (preview.dataset.blob) {
        const current = videoList.find(v => v.blob === preview.dataset.blob);
        if (current) {
            const activeItem = document.querySelector(`.video-item[data-id="${current.id}"]`);
            if (activeItem) activeItem.classList.add('active');
        }
    }
}

function playVideo(videoId) {
    const video = videoList.find(v => v.id == videoId);
    if (video) {
        preview.src = video.url;
        videoContainer.style.display = 'block';
        preview.dataset.blob = video.blob;
        
        // 更新活动状态
        document.querySelectorAll('.video-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-id="${videoId}"]`).classList.add('active');
    }
}

function downloadVideoFromList(videoId, format) {
    const video = videoList.find(v => v.id == videoId);
    if (!video) return;

    if (format === 'webm') {
        // 直接下载WebM格式
        const url = URL.createObjectURL(video.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = video.name + '.webm';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } else if (format === 'mp4') {
        // 转换并下载MP4格式
        convertToMp4(video, videoId);
    }
}

async function convertToMp4(video, videoId) {
    try {
        // 设置转换状态
        video.converting = true;
        updateVideoListDisplay();

        // 创建视频元素
        const videoElement = document.createElement('video');
        videoElement.crossOrigin = 'anonymous';
        videoElement.muted = true;
        videoElement.playsInline = true;
        
        // 等待视频加载
        await new Promise((resolve, reject) => {
            videoElement.onloadedmetadata = resolve;
            videoElement.onerror = reject;
            videoElement.src = video.url;
        });

        // 创建canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;

        // 创建MediaRecorder
        const stream = canvas.captureStream(30); // 30fps
        const mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/webm;codecs=vp9'
        });

        const chunks = [];
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                chunks.push(event.data);
            }
        };

        // 开始录制
        mediaRecorder.start();
        videoElement.play();

        // 绘制视频帧到canvas
        const drawFrame = () => {
            if (!videoElement.paused && !videoElement.ended) {
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                requestAnimationFrame(drawFrame);
            }
        };
        drawFrame();

        // 等待视频播放完成
        await new Promise((resolve) => {
            videoElement.onended = () => {
                mediaRecorder.stop();
                resolve();
            };
        });

        // 等待录制完成
        await new Promise((resolve) => {
            mediaRecorder.onstop = () => {
                const mp4Blob = new Blob(chunks, { type: 'video/mp4' });
                
                // 下载MP4文件
                const url = URL.createObjectURL(mp4Blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = video.name.replace('.webm', '.mp4');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                resolve();
            };
        });

        // 重置转换状态
        video.converting = false;
        updateVideoListDisplay();

    } catch (error) {
        console.error('MP4转换失败:', error);
        alert('MP4转换失败，请尝试下载WebM格式');
        
        // 重置转换状态
        video.converting = false;
        updateVideoListDisplay();
    }
}

function deleteVideo(videoId) {
    if (confirm('确定要删除这个视频吗？')) {
        const index = videoList.findIndex(v => v.id == videoId);
        if (index > -1) {
            // 如果删除的是当前播放的视频，清除播放器
            if (preview.dataset.blob === videoList[index].blob) {
                clearVideo();
            }
            
            // 释放URL对象
            URL.revokeObjectURL(videoList[index].url);
            
            videoList.splice(index, 1);
            saveVideoList();
            updateVideoListDisplay();
        }
    }
}

function clearVideo() {
    if (preview.src) {
        URL.revokeObjectURL(preview.src);
        preview.src = '';
        videoContainer.style.display = 'none';
        preview.dataset.blob = null;
        
        document.querySelectorAll('.video-item').forEach(item => {
            item.classList.remove('active');
        });
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function saveVideoList() {
    // 注意：这里只保存元数据，不保存实际的blob数据
    const metadata = videoList.map(video => ({
        id: video.id,
        name: video.name,
        size: video.size,
        date: video.date
    }));
    localStorage.setItem('videoList', JSON.stringify(metadata));
}

function loadVideoList() {
    const saved = localStorage.getItem('videoList');
    if (saved) {
        try {
            const metadata = JSON.parse(saved);
            // 注意：这里只能恢复元数据，实际的blob数据需要用户重新录制
            console.log('已保存的视频元数据:', metadata);
        } catch (error) {
            console.error('加载视频列表失败:', error);
        }
    }
}

function scrollToRecorder() {
    document.querySelector('.web-recorder').scrollIntoView({
        behavior: 'smooth'
    });
}

// 检查浏览器兼容性
if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    alert('您的浏览器不支持屏幕录制功能，请使用Chrome、Firefox或Edge浏览器。');
    startBtn.disabled = true;
}

// 页面卸载时清理资源
window.addEventListener('beforeunload', () => {
    if (preview.src) {
        URL.revokeObjectURL(preview.src);
    }
    videoList.forEach(video => {
        URL.revokeObjectURL(video.url);
    });
});

window.addEventListener('message', function(event) {
    if (event.data && event.data.from === 'recorder-extension') {
        if (event.data.action === 'startRecording' && !startBtn.disabled) {
            startBtn.click();
        } else if (event.data.action === 'pauseRecording' && !stopBtn.disabled) {
            // 主页可实现暂停逻辑（如有）
            if (typeof pauseRecording === 'function') pauseRecording();
        } else if (event.data.action === 'resumeRecording' && !stopBtn.disabled) {
            // 主页可实现恢复逻辑（如有）
            if (typeof resumeRecording === 'function') resumeRecording();
        } else if (event.data.action === 'stopRecording' && !stopBtn.disabled) {
            stopBtn.click();
        }
    }
}); 

</script>
</html>