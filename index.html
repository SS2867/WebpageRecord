<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频录制</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* 应用容器 */
    .app-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }

    /* 侧边栏样式 */
    .sidebar {
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
    }

    .sidebar-header h1 {
      font-size: 24px;
      margin: 0;
      color: #1a1a1a;
    }

    /* 控制面板 */
    .control-panel {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .recording-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #e9ecef;
      border-radius: 20px;
      font-size: 14px;
    }

    .recording-status.active {
      background: #dc3545;
      color: white;
    }

    .recording-status i {
      font-size: 16px;
    }

    /* 搜索框 */
    .search-box {
      position: relative;
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
    }

    .search-box input {
      width: 100%;
      padding: 10px 20px 10px 40px;
      border: 1px solid #dee2e6;
      border-radius: 20px;
      background: #fff;
      font-size: 14px;
    }

    .search-box i {
      position: absolute;
      left: 35px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    /* 录制列表 */
    .recorded-videos {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .video-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      border-radius: 10px;
      background: #fff;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .video-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .video-preview {
      width: 160px;
      height: 90px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
      background: #000;
    }

    .video-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 36px;
      height: 36px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: background-color 0.3s;
    }

    .play-button:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .play-button::after {
      content: '';
      border-style: solid;
      border-width: 8px 0 8px 12px;
      border-color: transparent transparent transparent white;
      margin-left: 2px;
    }

    .video-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .video-info h3 {
      font-size: 14px;
      margin: 0 0 8px;
      color: #1a1a1a;
    }

    .video-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .video-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #f8f9fa;
      color: #495057;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .video-actions button:hover {
      background: #e9ecef;
    }

    /* 按钮样式 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
    }

    /* 视频模态框样式 */
    .modal-fullscreen .modal-content {
      background-color: #000;
    }

    .modal-fullscreen .modal-header {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .video-container {
      background-color: #000 !important;
      min-height: calc(100vh - 200px);
    }

    .video-container video {
      max-height: calc(100vh - 200px);
      background: #000;
    }

    .video-controls {
      border-top: 1px solid #dee2e6;
    }

    .video-controls .progress {
      cursor: pointer;
      transition: height 0.2s;
    }

    .video-controls .progress:hover {
      height: 12px !important;
    }
  </style>
</head>
<body class="bg-light">
  <div class="app-container">
    <!-- 控制面板 -->
    <div class="control-panel">
      <div class="d-flex gap-2">
        <button id="startBtn" class="btn btn-primary flex-grow-1">
          <i class="bi bi-play-fill"></i>
          <span>开始录制</span>
        </button>
        <button id="stopBtn" class="btn btn-danger flex-grow-1" disabled>
          <i class="bi bi-stop-fill"></i>
          <span>停止录制</span>
        </button>
      </div>
    </div>

    <!-- 录制列表 -->
    <div id="recordedVideos" class="recorded-videos">
      <!-- 录制的视频将在这里显示 -->
    </div>
  </div>

  <!-- 视频预览模态框 -->
  <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="videoModalLabel">视频预览</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0 d-flex flex-column">
          <div class="video-container flex-grow-1 bg-dark d-flex align-items-center justify-content-center">
            <video id="modalVideo" class="w-100 h-100" style="object-fit: contain;"></video>
          </div>
          <div class="video-controls p-3 bg-light">
            <div class="d-flex align-items-center gap-3">
              <button id="playPauseBtn" class="btn btn-primary">
                <i class="bi bi-play-fill"></i>
              </button>
              <select id="playbackRate" class="form-select" style="width: auto;">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
              <div class="progress flex-grow-1" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    class VideoRecorder {
        constructor() {
            this.mediaStream = null;
            this.mediaRecorder = null;
            this.recordedChunks = [];
            this.recordings = [];
            this.currentRecording = null;
            this.startBtn = document.getElementById('startBtn');
            this.stopBtn = document.getElementById('stopBtn');
        }

        async requestPermission() {
            try {
                this.mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true
                });

                // 监听屏幕共享结束事件
                this.mediaStream.getTracks().forEach(track => {
                    track.addEventListener('ended', () => {
                        console.log('Screen sharing stopped');
                        this.handleStreamEnded();
                    });
                });

                return this.mediaStream;
            } catch (err) {
                throw new Error(`无法获取屏幕共享权限: ${err}`);
            }
        }

        // 处理流结束事件
        handleStreamEnded() {
            if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                this.stopRecording();
            }
            
            // 重置按钮状态
            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            
            // 移除实时预览
            if (this.currentRecording) {
                const liveItem = document.getElementById(`video-${this.currentRecording.id}`);
                if (liveItem) liveItem.remove();
            }
        }

        initializeRecorder(stream, mimeType = 'video/webm;codecs=vp9') {
            try {
                this.mediaRecorder = new MediaRecorder(stream, { mimeType });
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.recordedChunks.push(event.data);
                    }
                };

                this.mediaRecorder.onstop = () => {
                    if (this.recordedChunks.length > 0) {
                        const blob = new Blob(this.recordedChunks, { type: mimeType });
                        this.addRecording(blob);
                    }
                    this.cleanup();
                };
            } catch (err) {
                throw new Error(`初始化录制器失败: ${err}`);
            }
        }

        async startRecording() {
            try {
                const stream = await this.requestPermission();
                this.initializeRecorder(stream);
                this.recordedChunks = [];
                this.mediaRecorder.start(1000);
                
                // 创建当前录制项
                this.currentRecording = {
                    id: Date.now(),
                    timestamp: Date.now(),
                    stream: stream
                };
                
                // 显示实时预览
                this.currentRecording.url = null;
                this.displayRecording(this.currentRecording, true);
                
                // 更新按钮状态
                this.startBtn.disabled = true;
                this.stopBtn.disabled = false;

                return true;
            } catch (err) {
                console.error(err);
                this.handleStreamEnded();
                return false;
            }
        }

        stopRecording() {
            if (!this.mediaRecorder || this.mediaRecorder.state === 'inactive') return;
            
            try {
                this.mediaRecorder.stop();
                this.mediaStream.getTracks().forEach(track => track.stop());
                
                // 更新按钮状态
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                
                // 移除实时预览
                if (this.currentRecording) {
                    const liveItem = document.getElementById(`video-${this.currentRecording.id}`);
                    if (liveItem) liveItem.remove();
                }
            } catch (err) {
                console.error('停止录制时发生错误:', err);
                this.handleStreamEnded();
            }
        }

        addRecording(blob) {
            const url = URL.createObjectURL(blob);
            const timestamp = Date.now();
            const recording = {
                id: timestamp,
                url,
                blob,
                timestamp
            };
            this.recordings.push(recording);
            this.displayRecording(recording);
        }

        displayRecording(recording, isLive = false) {
            const recordedVideos = document.getElementById('recordedVideos');
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.id = `video-${recording.id}`;

            // 左侧预览区域
            const previewSection = document.createElement('div');
            previewSection.className = 'video-preview';
            
            const video = document.createElement('video');
            if (isLive) {
                video.srcObject = recording.stream;
                video.muted = true;
                video.autoplay = true;
            } else {
                video.src = recording.url;
                video.muted = false;
                const playButton = document.createElement('div');
                playButton.className = 'play-button';
                playButton.style.cursor = 'pointer';
                playButton.style.zIndex = '10';
                playButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    player.openModal(recording.url);
                });
                previewSection.appendChild(playButton);
            }
            previewSection.appendChild(video);

            // 右侧信息区域
            const infoSection = document.createElement('div');
            infoSection.className = 'video-info';
            
            const timestamp = new Date(recording.timestamp).toLocaleString();
            const formattedTime = new Date(recording.timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            infoSection.innerHTML = `
                <h3>录制时间：${timestamp}</h3>
                ${isLive ? '<p class="recording-status active">正在录制...</p>' : ''}
                <div class="text-muted small">${formattedTime}</div>
            `;

            const actions = document.createElement('div');
            actions.className = 'video-actions';

            const downloadBtn = document.createElement('button');
            downloadBtn.innerHTML = '<i class="bi bi-download"></i> 下载';
            downloadBtn.onclick = (e) => {
                e.stopPropagation();
                this.downloadRecording(recording);
            };

            const downloadMP4Btn = document.createElement('button');
            downloadMP4Btn.innerHTML = '<i class="bi bi-download"></i> 下载MP4';
            downloadMP4Btn.onclick = (e) => {
                e.stopPropagation();
                this.downloadAsMP4(recording);
            };

            actions.appendChild(downloadBtn);
            actions.appendChild(downloadMP4Btn);
            infoSection.appendChild(actions);

            videoItem.appendChild(previewSection);
            videoItem.appendChild(infoSection);
            
            // 添加点击事件打开视频
            videoItem.addEventListener('click', () => {
                player.openModal(recording.url);
            });

            recordedVideos.insertBefore(videoItem, recordedVideos.firstChild);
        }

        downloadRecording(recording) {
            const a = document.createElement('a');
            a.href = recording.url;
            a.download = `recording-${recording.timestamp}.webm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async downloadAsMP4(recording) {
            try {
                // 创建一个临时的video元素来加载视频
                const video = document.createElement('video');
                video.src = recording.url;
                
                // 等待视频加载完成
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });

                // 创建一个canvas元素
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');

                // 创建MediaRecorder来录制MP4
                const stream = canvas.captureStream();
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/mp4'
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording-${recording.timestamp}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // 开始录制
                mediaRecorder.start();
                video.play();

                // 逐帧绘制视频到canvas
                const drawFrame = () => {
                    if (video.ended || video.paused) {
                        mediaRecorder.stop();
                        return;
                    }
                    ctx.drawImage(video, 0, 0);
                    requestAnimationFrame(drawFrame);
                };
                drawFrame();
            } catch (err) {
                console.error('转换视频格式失败:', err);
                alert('转换视频格式失败，请重试');
            }
        }

        async shareRecording(recording) {
            try {
                if (navigator.share) {
                    const file = new File([recording.blob], `recording-${recording.timestamp}.webm`, {
                        type: recording.blob.type
                    });
                    await navigator.share({
                        title: '分享录制视频',
                        files: [file]
                    });
                } else {
                    alert('您的浏览器不支持分享功能');
                }
            } catch (err) {
                console.error('分享失败:', err);
                alert('分享失败');
            }
        }

        cleanup() {
            this.mediaStream?.getTracks().forEach(track => track.stop());
            this.mediaStream = null;
            this.mediaRecorder = null;
        }
    }

    class VideoPlayer {
        constructor() {
            this.modal = new bootstrap.Modal(document.getElementById('videoModal'));
            this.video = document.getElementById('modalVideo');
            this.playPauseBtn = document.getElementById('playPauseBtn');
            this.playbackRate = document.getElementById('playbackRate');
            this.progressBar = document.querySelector('.progress');
            this.progressFill = document.querySelector('.progress-bar');
            
            // 初始化基本控制
            this.initializeControls();
        }

        initializeControls() {
            // 播放/暂停控制
            this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
            
            // 播放速度控制
            this.playbackRate.addEventListener('change', (e) => {
                this.video.playbackRate = parseFloat(e.target.value);
            });
            
            // 进度条控制
            this.progressBar.addEventListener('click', (e) => {
                const rect = this.progressBar.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                this.video.currentTime = pos * this.video.duration;
            });
            
            // 更新进度条
            this.video.addEventListener('timeupdate', () => {
                const progress = (this.video.currentTime / this.video.duration) * 100;
                this.progressFill.style.width = `${progress}%`;
            });
        }

        togglePlayPause() {
            if (this.video.paused) {
                this.video.play();
                this.playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
            } else {
                this.video.pause();
                this.playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
            }
        }

        openModal(videoUrl) {
            console.log('Opening modal with URL:', videoUrl);
            
            // 重置视频源和状态
            this.video.src = videoUrl;
            this.video.currentTime = 0;
            this.progressFill.style.width = '0%';
            this.playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
            
            // 显示模态框
            this.modal.show();
            
            // 等待视频加载完成
            this.video.addEventListener('loadedmetadata', () => {
                console.log('Video metadata loaded');
                this.video.play()
                    .then(() => {
                        console.log('Video started playing');
                        this.playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
                    })
                    .catch(err => {
                        console.error('播放失败:', err);
                    });
            }, { once: true });
        }

        closeModal() {
            this.video.pause();
            this.modal.hide();
            this.video.src = '';
        }
    }

    const recorder = new VideoRecorder();
    const player = new VideoPlayer();
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        if (await recorder.startRecording()) {
            stopBtn.disabled = false;
        } else {
            startBtn.disabled = false;
        }
    });

    stopBtn.addEventListener('click', () => {
        recorder.stopRecording();
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });
  </script>
</body>
</html>